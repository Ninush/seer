fit_mstl <- forecast::mstl(training, mtd)
fit_mstl <- forecast::mstl(training, "ets")
fit_mstl <- forecast::mstl(training)
forecast(fit_mstl, h=2)
mtd = "ets"
fit_mstl <- forecast::mstl(training, method=mtd)
test <- rnorm(5)
forecast(fit_mstl, h=length(test))$mean
forecast(training, h=5)
library(seer)
data(M4)
a <- M4[["D1"]]$x
a <- msts(a, seasonal.periods = c(7,24))
forecast(a, h=5)
fit <- mstl(a)
forecast(fit, h=5)
fit <- mstl(a, method="arima")
?mstl
stlf(Training)
stlf(training)
training <- rnorm(15)
stlf(training)
?stlf
fit_mstl <- forecast::mstl(training)
fit_mstl$model
fit_mstl
class(fit_mstl)
?forecast
stlm(rnorm(20))
?forecast
m4_weekly <- subset(M4, "weeklt")
m4_weekly <- subset(M4, "weekly")
fit1 <- stlf(m4_weekly[[1]]$x)
fcast1 <- forecast(fit1, h=2)
fcast1
fit2 <- ets(m4_weekly[[1]]$x)
#' Calculate accuracy based on MSTL
#' @param ts_info list containing training and test part of a time series
#' @param function_name function to calculate the accuracy function, the arguments of this function
#' should be forecast, training and test set of the time series
#' @param length_out number of measures calculated by the function
#' @return accuracy measure calculated based on multiple seasonal decomposition
#' @export
accuracy_mstl <- function(ts_info, function_name, length_out){
training <- ts_info$training
test <- ts_info$test
h <- length(test)
tryCatch({
fit_stlf <- forecast::stlf(training)
forecastMSTL <- forecast(fit_stlf, h=length(test))$mean
ACCURACY <- match.fun(function_name)
MSTLaccuracy <- ACCURACY(forecast=forecastMSTL, test=test, training=training)
return(MSTLaccuracy)
}, error=function(e){return(rep(NA, length_out))})
}
function_name=cal_m4measures
length_out <- 2
tsinfo <- list(training=rnorm(15), test=rnorm(5))
#' Calculate accuracy based on MSTL
#' @param ts_info list containing training and test part of a time series
#' @param function_name function to calculate the accuracy function, the arguments of this function
#' should be forecast, training and test set of the time series
#' @param length_out number of measures calculated by the function
#' @return accuracy measure calculated based on multiple seasonal decomposition
#' @export
accuracy_mstl <- function(ts_info, function_name, length_out){
training <- ts_info$training
test <- ts_info$test
h <- length(test)
tryCatch({
fit_stlf <- forecast::stlf(training)
forecastMSTL <- forecast(fit_stlf, h=length(test))$mean
ACCURACY <- match.fun(function_name)
MSTLaccuracy <- ACCURACY(forecast=forecastMSTL, test=test, training=training)
return(MSTLaccuracy)
}, error=function(e){return(rep(NA, length_out))})
}
accuracy_mstl(ts_info, cal_m4measures, length_out = 2)
ts_info <- list(training=rnorm(15), test=rnorm(5))
accuracy_mstl(ts_info, cal_m4measures, length_out = 2)
library(Mcomp)
m3_monthly <- subset(M3, "monthly")
training <- m3_monthly[[1]]$x
test <- m3_monthly[[1]]$xx
ts_info <- list(training=training, test=test)
accuracy_mstl(ts_info, cal_m4measures, length_out = 2)
?stlf
library(seer)
#' @param seasonal if FALSE, restricts to features suitable for non-seasonal data
#' @param m frequency of the time series
#' @param lagmax maximum lag at which to calculate the acf (quarterly series-5L and monthly-13L)
#' @param database whether the time series is from mcomp or other
#' @param h forecast horizon
#' @param highfeq whether the time series is weekly, daily or hourly
#' @return dataframe: each column represent a feature and each row represent a time series
#' @importFrom magrittr %>%
#' @author Thiyanga Talagala
#' @export
cal_features <- function(tslist, seasonal=FALSE, m=1, lagmax=2L, database, h, highfreq){ # tslist = yearly_m1,
if (database == "other") {
train_test <- lapply(tslist, function(temp){list(training=head_ts(temp,h), test=tail_ts(temp, h))})
} else {
train_test <- lapply(tslist, function(temp){list(training=temp$x, test=temp$xx)})
}
train <- lapply(train_test, function(temp){temp$training})
ts_features_pkg <- tsfeatures::tsfeatures(train, c("entropy",
"lumpiness",
"stability",
"hurst",
"stl_features",
"acf_features",
"pacf_features",
"nonlinearity"))
if (seasonal==FALSE){
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5", "nonlinearity")
seer_features_nonseasonal <- lapply(train, function(temp1){c(
seer::e_acf1(temp1),
seer::unitroot(temp1))})
seer_features_nonseasonal_DF <- as.data.frame(do.call("rbind", seer_features_nonseasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_nonseasonal_DF)
} else {
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5","nonlinearity", "seasonal_strength",
"seas_pacf")
if(highfreq==TRUE){
seer_features_seasonal <- lapply(train, function(temp1){
acf_seasonalDiff(temp1, m, lagmax)})
} else {
seer_features_seasonal <- lapply(train, function(temp1){c(seer::holtWinter_parameters(temp1),
acf_seasonalDiff(temp1, m, lagmax))})
}
seer_features_seasonal_DF <- as.data.frame(do.call("rbind", seer_features_seasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_seasonal_DF)
}
ts_featuresDF <- as.data.frame(ts_features)
ts_featuresDF <- dplyr::rename(ts_featuresDF, "spikiness" = "spike")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "y_acf1" = "x_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff1y_acf1" = "diff1_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff2y_acf1" = "diff2_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "y_pacf5" = "x_pacf5")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff1y_pacf5" = "diff1x_pacf5")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff2y_pacf5" = "diff2x_pacf5")
if(seasonal==TRUE){
ts_featuresDF <- dplyr::rename(ts_featuresDF, "seasonality" = "seasonal_strength")
}
length <- lapply(train, function(temp){length(temp)})
length <- unlist(length)
ts_featuresDF$N <- length
if (highfreq==TRUE){
seer_features <- lapply(train, function(temp1){c(seer::acf5(temp1), seer::holt_parameters(temp1))})
} else {
seer_features <- lapply(train, function(temp1){seer::acf5(temp1)})
}
seer_feature_DF <- as.data.frame(do.call("rbind", seer_features))
featureDF <- dplyr::bind_cols(ts_featuresDF,seer_feature_DF)
return(featureDF)
}
#'@examples
require(Mcomp)
data(M3)
yearly_m3 <- subset(M3, "yearly")
cal_features(yearly_m3, database="M3", h=6, highfreq=FALSE)
library(tsfeatures)
library(forecast)
#'@examples
require(Mcomp)
data(M3)
yearly_m3 <- subset(M3, "yearly")
cal_features(yearly_m3, database="M3", h=6, highfreq=FALSE)
library(seer)
data("M4")
d1 <- subset(M4, "daily")
plot(d[[1]]$x)
plot(d1[[1]]$x)
acf(d1[[1]]$x)
frequency(d1[[1]]$x)
s1 <- diff(d[[1]]$x, lag=365, differences = 1)
s1 <- diff(d1[[1]]$x, lag=365, differences = 1)
acf(s1)
acf(d1[[1]]$x)
acf(s1)
acf(d1[[2]]$x)
acf(d1[[3]]$x)
s1 <- diff(d1[[3]]$x, lag=365, differences = 1)
acf(S1)
acf(s1)
s1
s1 <- diff(d1[[3]]$x, lag=365, differences = 1)
s1
acf(d1[[4]]$x)
acf(d1[[5]]$x)
acf(d1[[6]]$x)
acf(d1[[7]]$x)
acf(d1[[8]]$x)
acf(d1[[9]]$x)
acf(d1[[10]]$x)
acf(d1[[11]]$x)
acf(d1[[12]]$x)
acf(d1[[13]]$x)
acf(d1[[14]]$x)
acf(d1[[15]]$x)
plot(d1[[15]]$x)
s1 <- diff(d1[[3]]$x, lag=7, differences = 1)
acf(s1)
s1 <- diff(d1[[1]]$x, lag=7, differences = 1)
acf(s1)
ets(d1[[1]]$x)
ets(d1[[3]]$x)
ets(d1[[4]]$x)
plot(d1[[4]]$x)
frequency(d1[[4]]$x)
ets(d1[[5]]$x)
length(d1[[5]]$x)
ets(d1[[6]]$x)
library(seer)
library(seer)
library(seer)
install.packages("ggplot2")
library(ggplot2)
install.packages("forecast")
library(seer)
data(M4)
M4_weekly <- subset(M4, "weekly")
sl <- sapply(M4_weekly, function(temp){length(temp$x)})
which(s1==80)
s1
which(sl==80)
aa <- M4_weekly[[295]]
aa
train <- aa$x
length(train)
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
required_length <- 2*frequency(temp)
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(temp)
}
})
temp <- train
length_temp <- length(temp)
required_length <- 2*frequency(temp)
length_temp > required_length
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
required_length <- 2*frequency(temp)
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(com)
}
})
train
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
required_length <- 2*frequency(temp)
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(com)
}
})
length_temp <- length(temp)
required_length <- 2*frequency(temp)
required_length
length_temp
length_temp > required_length
fcast_h <- required_length-length_temp
fcast_h
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
length(com)
tsfeatures::stl_features(com)
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
required_length <- 2*frequency(temp)+1
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(com)
}
})
library(seer)
library(seer)
library(seer)
library(seer)
strings <- c("seasonal_strength", "seasonal_strength1", "sea_strength", "seasonal_strengt")
strings <- c("seasonal_strength", "seasonal_strength1", "sea_strength", "seasonal_strengt")
grep("seasonal_strength", strings, value = TRUE)
class(vec)
vec <- grep("seasonal_strength", strings, value = TRUE)
class(vec)
data(M4)
m4d <- subset(M4, "daily")
a <- m4d[[1]]$x
d1 <- msts(a, seasonal.periods = c(7, 365.25))
d2 <- msts(a, seasonal.periods = c(365.25))
library(seer)
d1 <- msts(a, seasonal.periods = c(7, 365.25))
library(forecast)
d1 <- msts(a, seasonal.periods = c(7, 365.25))
d2 <- msts(a, seasonal.periods = c(365.25))
listd <- list(d1, d2)
#' @param seasonal if FALSE, restricts to features suitable for non-seasonal data
#' @param m frequency of the time series
#' @param lagmax maximum lag at which to calculate the acf (quarterly series-5L and monthly-13L)
#' @param database whether the time series is from mcomp or other
#' @param h forecast horizon
#' @param highfreq whether the time series is weekly, daily or hourly
#' @return dataframe: each column represent a feature and each row represent a time series
#' @importFrom magrittr %>%
#' @author Thiyanga Talagala
#' @export
cal_features <- function(tslist, seasonal=FALSE, m=1, lagmax=2L, database, h, highfreq){ # tslist = yearly_m1,
if (database == "other") {
train_test <- lapply(tslist, function(temp){list(training=head_ts(temp,h), test=tail_ts(temp, h))})
} else {
train_test <- lapply(tslist, function(temp){list(training=temp$x, test=temp$xx)})
}
train <- lapply(train_test, function(temp){temp$training})
ts_features_pkg <- tsfeatures::tsfeatures(train, c("entropy",
"lumpiness",
"stability",
"hurst",
# "stl_features",
"acf_features",
"pacf_features",
"nonlinearity"))
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
# tryCatch({
freq_temp <- frequency(temp)
# }, error=function(e){freq_temp <- m})
required_length <- 2*freq_temp+1
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(com)
}
})
stl_df <- as.data.frame(do.call("rbind", stl_ftrs))
ts_features_pkg <- dplyr::bind_cols(ts_features_pkg,stl_df)
if (seasonal==FALSE){
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5", "nonlinearity")
seer_features_nonseasonal <- lapply(train, function(temp1){c(
seer::e_acf1(temp1),
seer::unitroot(temp1))})
seer_features_nonseasonal_DF <- as.data.frame(do.call("rbind", seer_features_nonseasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_nonseasonal_DF)
} else {
tf <- names(ts_features_pkg)
seasonalFeatures <- grep("seasonal_strength", tf, value = TRUE)
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5","nonlinearity", "seasonal_strength",
"seas_pacf", seasonalFeatures)
if(highfreq==TRUE){
seer_features_seasonal <- lapply(train, function(temp1){
acf_seasonalDiff(temp1, m, lagmax)})
} else {
seer_features_seasonal <- lapply(train, function(temp1){c(seer::holtWinter_parameters(temp1),
acf_seasonalDiff(temp1, m, lagmax))})
}
seer_features_seasonal_DF <- as.data.frame(do.call("rbind", seer_features_seasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_seasonal_DF)
}
ts_featuresDF <- as.data.frame(ts_features)
ts_featuresDF <- dplyr::rename(ts_featuresDF, "spikiness" = "spike")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "y_acf1" = "x_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff1y_acf1" = "diff1_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff2y_acf1" = "diff2_acf1")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "y_pacf5" = "x_pacf5")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff1y_pacf5" = "diff1x_pacf5")
ts_featuresDF <- dplyr::rename(ts_featuresDF, "diff2y_pacf5" = "diff2x_pacf5")
if(seasonal==TRUE){
ts_featuresDF <- dplyr::rename(ts_featuresDF, "seasonality" = "seasonal_strength")
}
length <- lapply(train, function(temp){length(temp)})
length <- unlist(length)
ts_featuresDF$N <- length
if (highfreq==FALSE){
seer_features <- lapply(train, function(temp1){c(seer::acf5(temp1), seer::holt_parameters(temp1))})
} else {
seer_features <- lapply(train, function(temp1){seer::acf5(temp1)})
}
seer_feature_DF <- as.data.frame(do.call("rbind", seer_features))
featureDF <- dplyr::bind_cols(ts_featuresDF,seer_feature_DF)
return(featureDF)
}
cal_features(d1, seasonal=TRUE, m=7, lagmax=8L, database="other", h=0, highfreq = T)
train = d1
train
ts_features_pkg <- tsfeatures::tsfeatures(train, c("entropy",
"lumpiness",
"stability",
"hurst",
# "stl_features",
"acf_features",
"pacf_features",
"nonlinearity"))
library(tsfeatures)
library(ForeCA)
ts_features_pkg <- tsfeatures::tsfeatures(train, c("entropy",
"lumpiness",
"stability",
"hurst",
# "stl_features",
"acf_features",
"pacf_features",
"nonlinearity"))
# calculation of stl features: handling short and long time series
stl_ftrs <- lapply(train, function(temp){
length_temp <- length(temp)
# tryCatch({
freq_temp <- frequency(temp)
# }, error=function(e){freq_temp <- m})
required_length <- 2*freq_temp+1
if (length_temp > required_length) {tsfeatures::stl_features(temp)
} else {
fcast_h <- required_length-length_temp
fcast <- forecast::forecast(temp, fcast_h)$mean
com <- ts(c(temp,fcast), start=start(temp), frequency=frequency(temp))
tsfeatures::stl_features(com)
}
})
stl_df <- as.data.frame(do.call("rbind", stl_ftrs))
ts_features_pkg <- dplyr::bind_cols(ts_features_pkg,stl_df)
if (seasonal==FALSE){
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5", "nonlinearity")
seer_features_nonseasonal <- lapply(train, function(temp1){c(
seer::e_acf1(temp1),
seer::unitroot(temp1))})
seer_features_nonseasonal_DF <- as.data.frame(do.call("rbind", seer_features_nonseasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_nonseasonal_DF)
} else {
tf <- names(ts_features_pkg)
seasonalFeatures <- grep("seasonal_strength", tf, value = TRUE)
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5","nonlinearity", "seasonal_strength",
"seas_pacf", seasonalFeatures)
if(highfreq==TRUE){
seer_features_seasonal <- lapply(train, function(temp1){
acf_seasonalDiff(temp1, m, lagmax)})
} else {
seer_features_seasonal <- lapply(train, function(temp1){c(seer::holtWinter_parameters(temp1),
acf_seasonalDiff(temp1, m, lagmax))})
}
seer_features_seasonal_DF <- as.data.frame(do.call("rbind", seer_features_seasonal))
ts_features <- dplyr::bind_cols(ts_features1, seer_features_seasonal_DF)
}
tf <- names(ts_features_pkg)
tf
seasonalFeatures <- grep("seasonal_strength", tf, value = TRUE)
ts_features1 <- ts_features_pkg %>% dplyr::select ("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5","nonlinearity", "seasonal_strength",
"seas_pacf", seasonalFeatures)
seasonalFeatures
select_features <- c("entropy", "lumpiness", "stability", "hurst",
"trend", "spike", "linearity", "curvature",
"e_acf1", "x_acf1", "diff1_acf1", "diff2_acf1",
"x_pacf5","diff1x_pacf5", "diff2x_pacf5","nonlinearity",
"seas_pacf", seasonalFeatures)
ts_features1 <- ts_features_pkg %>% dplyr::select (select_features)
ts_features1
a <- data.frame(aa=1:5, bb=1:5)
b <- data.frame(aa=3:7, bb=6:10)
merge(a, b, by="a", all=T)
a <- data.frame(aa=1:5, bb=1:5)
b <- data.frame(aa=3:7, bb=6:10)
merge(a, b, by="aa", all=T)
merge(a, b)
df1 <- data.frame(a=1:5, b=1:5)
df2 <- data.frame(a=1:5, b=6:10, c=11:15)
df1
df2
rbind(df1, df2)
combind <- data.frame(a=rep(1:5, 2), b=c(1:5, 6:10), c=c(NA, NA, NA, NA, NA, 11, 12, 13,14,15))
combind
dplyr::bind_rows(df1, df2)
plyr::rbind.fill(df1, df2)
